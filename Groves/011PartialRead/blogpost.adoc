:imagesdir: images

= Sub-document API in Couchbase 4.5 - Partial Reads with .NET

Until Couchbase 4.5, working with large documents was basically an all-or-nothing operation. You get the full document, make a change, and then write the full document. This is true even if you are only interested in one small portion of document.

image::20160607_143904.jpg[A sub-document is a portion of a whole document]

Couchbase 4.5 introduces a sub-document API. This allows you to get information about a portion of a document.

Now, with the N1QL query language, you could create a query that only returns the fields you are interested in, but with the sub-document API, you can do it with just the document key.

== Getting a sub-document

If you think of a JSON object as a tree, then you can think of a sub-document as a branch of that tree. For example, consider this simple JSON document:

[source,javascript]
----
{
    "username": "mgroves",
    "profile": {
        "phoneNumber": "123-456-7890",
        "address": {
            "street": "123 main rd",
            "city": "Columbus",
            "state": "Ohio"
        }
    }
}
----

In this example, the "root" of the document has two branches: `username` and `profile`. Then, `profile` has two branches itself: `phoneNumber` and `address`. And so on.

We already know how to get an entire document using the .NET SDK. It looks something like this:

[source,C#]
----
include::PartialReadExample/PartialReadExample/Program.cs[tags=WholeDocument]
----

That code gets the whole document (by key), and writes out the whole document to console (it uses JsonConvert and Formatting.Indented to make it look nicer).

In this example, the document is very small. But now imagine that it's much larger, and you only want to get the username. It would be a waste to pull down an entire document just for one field. This is where the sub-document API comes in. You can pull back a portion, or sub-document, of a JSON document, using the sub-document API:

[source,C#]
----
include::PartialReadExample/PartialReadExample/Program.cs[tags=ShowSubdocument]
----

Notice that this method has a `path` parameter. This is a simple dotted syntax telling Couchbase how to navigate the "JSON tree" to find the subdocument that you're interested in. In the above example, if I just want username, then the path would be `username`. If I just want the city of the address, the path would be `profile.address.city`. Think of it like a very simple XPath for JSON, except forget I said that because XPath can be a nightmare.

This method uses the `LookupIn<>` method on `IBucket` instead of `Get<>`. When using `LookupIn`, you can chain sub-document operations (like `Get(path)` above) followed by an `Execute`. The result of `Execute` is an `IDocumentFragment<>`. With this object, you can check to see if the sub-document request succeeded or not, as well as get the content of the sub-document.

Now that I've written this method, I can try it out on some other paths:

[source,C#]
----
include::PartialReadExample/PartialReadExample/Program.cs[tags=TryShowSubDocument]
----

This is the sort of output I would expect:

```
===Subdocument (username)
"mgroves"

===Subdocument (profile)
{
  "phoneNumber": "123-456-7890",
  "address": {
    "street": "123 Main Rd",
    "city": "Columbus",
    "state": "Ohio"
  }
}

===Subdocument (profile.phoneNumber)
"123-456-7890"

===Subdocument (profile.address.street)
"123 Main Rd"

===Subdocument (profile.address.province)
SubDocMultiPathFailure
```

Note that the last one didn't succeed, because there is no `province` field in the (sub)document.

== Checking to see if a sub-document path exists

That brings us to another feature of the sub-document API. You can check to see if a field (aka a path) exists in a document.

[source,C#]
----
include::PartialReadExample/PartialReadExample/Program.cs[tags=DoesSubdocumentExist]
----

In this example, we're still using `LookupIn`, but now I'm chaining the `Exists` method before the `Execute`.

Now, let's try out the `DoesSubdocumentExist` method:

[source,C#]
----
include::PartialReadExample/PartialReadExample/Program.cs[tags=TryDoesSubdocumentExist]
----

An output that I would expect to see is:

----
== Checking if path 'profile.address.state' exists in document 'Profile::8842'
SubDocument 'profile.address.state' exists

== Checking if path 'profile.address.province' exists in document 'Profile::8842'
SubDocument 'profile.address.province' doesn't exist
----

== Conclusion

The sub-document API gives you the ability to be more granular in your interactions with documents, and return just the portions that you need.

Partial writes will be covered in a future blog post, so stay tuned.

Leave a comment below, link:http://twitter.com/mgroves[talk to me on Twitter], or email me (matthew.groves AT couchbase DOT com) if you have any questions or comments.